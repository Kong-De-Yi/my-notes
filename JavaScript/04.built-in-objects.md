# 日期和时间（Date）

## 创建

- 没有单独的日期或者时间对象
- new Date()：用当前时区的日期和时间创建
- new Date(milliseconds)：用时间戳整数（自 1970-01-01 00:00:00 UTC+0 经过的毫秒数）创建（正负皆可）
- new Date(datestring)：用日期时间格式字符串创建（使用当前时区）
- new Date(year,month,date,hours,minutes,seconds,ms)：通过当前时区日期组件创建
  - 只有 year 和 month 必须
  - year 应为 4 位数，2 位数视为 19XX
  - month 取值 0-11，代表 1 月-12 月
  - date 默认值 1
  - hours/minutes/seconds/ms 默认值 0

```javascript
let now = new Date(); //当前日期和时间
let Jan01_1970 = new Date(0); //1970年1月1日
let Jan02_1970 = new Date(24 * 3600 * 1000); //1970年1月2日
let Dec31_1969 = new Date(-24 * 3600 * 1000); //1969年12月31日
let date = new Date("2017-01-26"); //字符串格式创建
let date = new Date(2017, 0); //2017年1月1日 00:00:00
let date = new Date(2017, 0, 1); //2017年1月1日 00:00:00
let date = new Date(2017, 0, 1, 2, 3, 4, 567); //2017年1月1日02:03:04.567
```

## 获取日期组件

- 基于当地时区
  - getFullYear()：获取 4 位数年份
  - getMonth()：获取月份：0-11
  - getDate()：获取日期：1-31
  - getHours()/getMinutes()/getSeconds()/getMilliseconds()：获取时/分/秒/毫秒
  - getDay()：获取一周的第几天，0-6（星期日-星期六）
  - 以上方法都有 UTC 变体：getUTCxxx()
  - getTime()：返回日期时间戳（从 1970-1-1 00:00:00 UTC+0 开始到现在经过的毫秒数)
  - getTimezoneOffset()：返回 UTC 与本地时区的时差，以分钟为单位

```javascript
let date = new Date(); //当地时区的此刻时间
alert(date.getHours()); //当地时区的小时数
alert(date.getUTCHours()); //UTC+0时区的小时数

alert(new Date().getTimezoneOffset()); //返回 UTC 与本地时区的时差，以分钟为单位
```

## 设置日期组件

- setFullYear(year,[month],[date])
- setMonth(month,[date])
- setDate(date)
- setHours(hour,[min],[sec],[ms])
- setMinutes(min,[sec],[ms])
- setSeconds(sec,[ms])
- setMilliseconds(ms)
- 以上方法都有 UTC 变体：setUTCxxx(...)
- setTime(milliseconds)：使用自 1970-01-01 00:00:00 UTC+0 以来的毫秒数来设置整个日期

```javascript
let today = new Date();
today.setHours(0);
alert(today); //日期不变，小时数改为0
today.setHours(0, 0, 0, 0);
alert(today); //日期不变，时间为00:00:00
```

## 自动校准

- 设置超范围的组件数值，会自动校准

```javascript
let date = new Date(2013, 0, 32);
alert(date); //2013年2月1日

//获取指定时间段后的日期
let date = new Date(2016, 1, 28);
date.setDate(date.getDate() + 2); //加上2天
alert(date); //2016年3月1日，正确处理闰年

//获取70秒后的日期
let date = new Date();
date.setSeconds(date.getSeconds() + 70);
alert(date);

//可以设置0或负数，表示时间往前推
let date = new Date(2016, 0, 2); //2016年1月2日
date.setDate(1); //设置为当月的第1天
date.setDate(0); //设置为上月的最后1天
```

## 日期转换为数字

- Date 对象转换为数字，得到的示时间戳，等同于 date.getTime()
- 日期相减得到以毫秒为单位的时间差（时间测量）

```javascript
let date = new Date();
alert(+date); //时间戳 1768611447633

//时间测量
let start = new Date();
for (let i = 0; i < 100000; i++) {
  let doSomething = i * i * i;
}
let end = new Date();
alert(`The loop took ${end - start} ms`);
```

## 获取当前的时间戳：Date.now()

- 效果相当于 new Date().getTime()，但不会创建 Date 对象，效率更高

```javascript
//这样效率更高
let start = Date.now(); //从1970年1月1日至今的时间戳
for (let i = 0; i < 100000; i++) {
  let doSomething = i * i * i;
}
let end = Date.now();
alert(`The loop took ${end - start} ms`); //相减的是时间戳，不是日期
```

## 基准测试

- 为了得到更加可靠的度量，整个度量测试包应该运行多次

## 从字符串提取时间：Date.parse(str)

- 字符串格式：YYYY-MM-DDTHH:mm:ss.sssZ（只有 YYYY 是必须的)
- YYYY-MM-DD：年-月-日
- T：分隔符
- HH:mm:ss.sss：小时:分钟:秒:毫秒
- Z：+-hh:mm 格式时区，单个 Z 代表 UTC+0 时区
- 返回时间戳或者 NaN

```javascript
let ms = Date.parse("2012-01-26T13:51:50.417-07:00");
alert(ms); //1327611110417  (时间戳)

//通过时间戳创建Date对象
let date = new Date(Date.parse("2012-01-26T13:51:50.417-07:00"));
```

# JSON

- 问题：将对象转化为字符串（通过自定义 toString 或者遍历属性）
- 解决：JSON 对象

## JSON.stringify()：对象 —> JSON

- 语法：

```javascript
let json=JSON.stringify(value[,replacer,space])
/*
value：要编码的值
replacer：要编码的属性数组或映射函数function(key,value)
space：格式化的空格数量或者字符串
*/
```

- 字符串使用双引号，JSON 中没有单引号或反引号
- 对象属性的 key 也是双引号
- 支持的数据类型
  - Objects{...}
  - Arrays[...]
  - Primitives：strings/numbers/boolean(true 和 fasle)/null
- JSON 与语言无关，特定于 JavaScript 的对象属性会被跳过（方法，Symbol，undefined)
- 支持嵌套对象转换
- 不能有循环引用

```javascript
let student = {
  name: "John",
  age: 30,
  isAdmin: false,
  courses: ["html", "css", "js"],
  spouse: null,
};

let json = JSON.stringify(student);
alert(typeof json); //string
alert(json);
/*JSON编码的对象
{
  "name":"John",
  "age":30,
  "isAdmin":false,
  "courses":["html","css","js"],
  "spouse":null}
*/

//其他类型
alert(JSON.stringify(1)); //1
alert(JSON.stringify("test")); //"test"
alert(JSON.stringify(true)); //true
alert(JSON.stringify([1, 2, 3])); //[1,2,3]

//会跳过特定于JavaScript的对象属性
let user = {
  sayHi() {
    alert("Hello");
  },
  [Symbol("id")]: 123,
  something: undefined,
};
alert(JSON.stringify(user)); //{}

//支持嵌套对象转换
let meetup = {
  title: "Conference",
  room: { number: 23, participants: ["john", "ann"] },
};
alert(JSON.stringify(meetup));
/*{ "title":"Conference",
    "room":{"number":23,"participants":["John","ann"]}
  }*/

//不能有循环引用
let room = { number: 23 };
let meetup = { title: "Conference", participants: ["john", "ann"] };

meetup.palce = room;
room.occupiedBy = meetup;
JSON.stringify(meetup); //Error:Converting circular structure to JSON
```

### 排除和转换：replacer

- 可用来过滤掉循环引用

```javascript
let room = { number: 23 };
let meetup = {
  title: "Conference",
  participants: [{ name: "John" }, { name: "Alice" }],
  place: room,
};
room.occupiedBy = meetup;
alert(JSON.stringify(meetup, ["title", "participants"]));
//{"title":"Conference","participants":[{},{}]} ,name不在列表中
alert(
  JSON.stringify(meetup, ["title", "participants", "place", "name", "number"]),
);
/*{ "title":"Conference",
    "participants":[{"name":"John"},{"name":"Alice"}],
    "place":{"number":23}
  }*/

//使用映射函数
let room = { number: 23 };
let meetup = {
  title: "Conference",
  participants: [{ name: "John" }, { name: "Alice" }],
  place: room,
};
room.occupiedBy = meetup;
alert(
  JSON.stringify(meetup, function replacer(key, value) {
    alert(`${key}:${value}`);
    return key == "occupiedBy" ? undefined : value;
  }),
);
/* key:value pairs that come to replacer:
:             [object Object]
title:        Conference
participants: [object Object],[object Object]
0:            [object Object]
name:         John
1:            [object Object]
name:         Alice
place:        [object Object]
number:       23
occupiedBy: [object Object]
*/
```

### 格式化：space

- 嵌套对象的内部缩进

```javascript
let user = { name: "John", age: 25, roles: { isAdmin: false, isEditor: true } };
alert(JSON.stringify(user, null, 2));
/* 两个空格的缩进：
{
  "name": "John",
  "age": 25,
  "roles": {
    "isAdmin": false,
    "isEditor": true
  }
}
*/
```

## 自定义：toJSON()

- 对象可以自定义toJSON()，JSON.stringify()会自动调用

```javascript
let room = { number: 23 };
let meetup = {
  title: "Conference",
  date: new Date(Date.UTC(2017, 0, 1)), //Date对象有内建toJSON()
  room,
};
alert(JSON.stringify(meetup));
/*{ "title":"Conference",
    "date":"2017-01-01T00:00:00.000Z",
    "room":{"number":23}
  }*/

let room = {
  number: 23,
  toJSON() {
    return this.number;
  },
};
let meetup = { title: "Conference", room };
alert(JSON.stringify(room)); //23
alert(JSON.stringify(meetup));
/*{ "title":"Conference",
    "room":23
  }*/
```

## JSON.parse()：JSON —> 对象

- 语法：

```javascript
/*  str：要解析的JSON字符串
    reviver：可选function(key,value),对值进行转换
*/
let value = JSON.parse(str, [reviver]);
```

```javascript
//转换成数组
let numbers = "[0,1,2,3]";
numbers = JSON.parse(numbers);
//转换嵌套对象
let userData = '{"name":"John","age":35,"isAdmin":false,"friends":[0,1,2,3]}';
let user = JSON.parse(userData);
alert(user);
```

### 自定义转化：reviver

```javascript
let str = `{"title":"Conference","date":"2017-11-30T12:00:00.000Z"}`;
let meetup = JSON.parse(str); //Error,date无法自动从字符串转换为Date对象

let meetup = JSON.parse(str, function (key, value) {
  //正常工作
  return key == "date" ? new Date(value) : value;
});
```
